<!DOCTYPE html>
<html>
	<head>
		<title>CubeAdder</title>
		<meta charset="utf-8">
		<meta http-equiv="cache-control" content="max-age=0">
		<meta http-equiv="cache-control" content="no-cache">
		<meta http-equiv="expires" content="0">
		<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT">
		<meta http-equiv="pragma" content="no-cache">
		<style>
			body { margin: 0; overflow: hidden;}
			canvas { width: 100%; height: 100% }
		</style>
	</head>

	<body>
		<div id="WebGL-output"></div>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r71/three.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.5/dat.gui.js"> </script>
		<script type="text/javascript">

			function init(){
				var boolean = true;
				var scene = new THREE.Scene();
				var controls = new function(){
					this.lightIntensity = 20;
					this.cuboidsAdded = 1;
					this.cuboidsRemoved = 1;
					this.rotationSpeedX = 20; // 20
					this.rotationSpeedY = 20;
					this.rotationSpeedZ = 20;
					this.numberOfCuboids = 0;

					this.addCuboids = function(){
						for(var i = controls.cuboidsAdded - 1; i >= 0; i--){
							addCuboid();
						}
						console.log("Added " + Math.floor(controls.cuboidsAdded) + " cuboids.");
					}

					this.removeCuboids = function(){
						for(var i = controls.cuboidsRemoved - 1; ((i >= 0) && (boolean = true)); i--){
							removeCuboid();
						}
						if(boolean == true){
							console.log("Removed " + Math.floor(controls.cuboidsRemoved) + " cuboids.");
						}
						else{
							console.log("Removed all cuboids.");
						}
					}

				}
				var gui = new dat.GUI();
				gui.add(controls, 'lightIntensity', 0, 100, 1);
				gui.add(controls, 'cuboidsAdded', 0, 100, 10);
				gui.add(controls, 'cuboidsRemoved', 0, 50, 1);
				gui.add(controls, 'rotationSpeedX', 0, 50);
				gui.add(controls, 'rotationSpeedY', 0, 50);
				gui.add(controls, 'rotationSpeedZ', 0, 50);
				gui.add(controls, 'numberOfCuboids').listen();
				gui.add(controls, 'addCuboids');
				gui.add(controls, 'removeCuboids');

				scene.fog = new THREE.Fog(0xeee8aa, 0.01);

				function setCuboidSize (){
					return Math.ceil(Math.random() * 6);
				}

				function setSign (){
					var number = Math.round(Math.random());
					if(number == 0){
						number = -1;
					}
					return number;
				}

				var sign = setSign();

				var size = 0;

				var width = window.innerWidth;
				var height = window.innerHeight;



				var camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);

				var renderer = new THREE.WebGLRenderer();
				renderer.setClearColor(new THREE.Color(0xEEEEEE));
				renderer.setSize(width, height);
				renderer.shadowMapEnabled = true;

				var axes = new THREE.AxisHelper(20);
				scene.add(axes);

				var planeWidth = 40;
				var planeHeight = 40;
				var planeGeometry = new THREE.PlaneGeometry(planeWidth, planeHeight);
				var planeMaterial = new THREE.MeshLambertMaterial({color: 0xcccccc});
				var plane = new THREE.Mesh(planeGeometry, planeMaterial);
				plane.rotation.x = -0.5 * Math.PI;
				plane.position.x = 0;
				plane.position.y = 0;
				plane.position.z = 0;
				plane.reciveShadow = true;
				scene.add(plane);

				camera.position.x = 0;
				camera.position.y = 10;
				camera.position.z = 35;
				camera.lookAt(scene.position);
				scene.add(camera);

				var ambientLight = new THREE.AmbientLight(0x0c0c0c);
				scene.add(ambientLight);

				var spotLight = new THREE.SpotLight(0xffffff);
				spotLight.position.x = 0;
				spotLight.position.y = 10;
				spotLight.position.z = 30;
				spotLight.castShadow = true;
				scene.add(spotLight);


				function addCuboid() {
					var cuboidSizeX = setCuboidSize();
					var cuboidSizeY = setCuboidSize();
					var cuboidSizeZ = setCuboidSize();

					var cuboidGeometry = new THREE.BoxGeometry(cuboidSizeX, cuboidSizeY, cuboidSizeZ);
					var cuboidMaterial = new THREE.MeshLambertMaterial({color: Math.random() * 0xffffff});
					var cuboid = new THREE.Mesh(cuboidGeometry, cuboidMaterial);
					cuboid.castShadow = true;

					cuboid.id = "cube-" + scene.children.length;
					cuboid.position.x = (Math.random() * sign) * planeWidth / 2 - (cuboidSizeX * sign);
					sign = setSign();
					cuboid.position.y = 3;
					cuboid.position.z = (Math.random() * sign) * planeHeight / 2 - (cuboidSizeZ * sign);
					sign = setSign();
					scene.add(cuboid);
				}

				function removeCuboid(){
					var allChildren = scene.children;
					var lastObject = allChildren[allChildren.length - 1];
					if(lastObject instanceof THREE.Mesh && lastObject != plane){
						scene.remove(lastObject);
					}
					else {
						boolean = false;
					}
				}

				document.getElementById("WebGL-output").appendChild(renderer.domElement);
				renderScene();

				function renderScene(){
					scene.traverse(
						function(obj){
							if(obj instanceof THREE.Mesh && obj != plane){
								obj.rotation.x+=controls.rotationSpeedX/1000;
								obj.rotation.y+=controls.rotationSpeedY/1000;
								obj.rotation.z+=controls.rotationSpeedZ/1000;
							}
						}
					);

					spotLight.intensity = controls.lightIntensity/10;

					controls.numberOfCuboids = scene.children.length - 6;

					requestAnimationFrame(renderScene);
					renderer.render(scene, camera);
				}
			}
			window.onload = init;

		</script>

	</body>
</html>
